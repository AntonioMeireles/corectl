#!/bin/bash

ENV=$1

if [[ -z "$ENV" ]]; then
    echo "usage: $0 /etc/environment" >&2
    exit 1
fi

# Make sure that the file is writable
touch $ENV
if [[ $? -ne 0 ]]; then
    echo "$0: unable to modify ${ENV}" >&2
    exit 1
fi


[[ $(</proc/cmdline) =~ uuid=([^\ ]+) ]]; UUID=${BASH_REMATCH[1]}
[[ $(</proc/cmdline) =~ endpoint=([^\ ]+) ]]; ENDPOINT=${BASH_REMATCH[1]}

# wait for eth0 to get up...
get_ipv4() {
    IFACE="${1}"
    local ip
    while [ -z "${ip}" ]; do
        ip=$(ip -4 -o addr show dev "${IFACE}" scope global | \
            gawk '{split ($4, out, "/"); print out[1]}')
        sleep .1
    done
    echo "${ip}"
}

COREOS_PUBLIC_IPV4=$(get_ipv4 eth0)
# XXX if/when we get it right
COREOS_PRIVATE_IPV4=${COREOS_PUBLIC_IPV4}

block-until-url "${ENDPOINT}"

META="$(mktemp)"
curl -Ls ${ENDPOINT}/setup > ${META}
HOSTNAME="$(jq -r .VM.Name ${META})"
HOMEDIR="$(jq -r .Caller.User.HomeDir ${META})"
NFS="$(jq -r .Caller.Network.Address ${META})"

( echo ENDPOINT=${ENDPOINT}
  echo UUID=${UUID}
  echo HOSTNAME="${HOSTNAME}"
  echo HOMEDIR="${HOMEDIR}"
  echo NFS="${NFS}"

  echo COREOS_PUBLIC_IPV4=${COREOS_PUBLIC_IPV4}
  echo COREOS_PRIVATE_IPV4=${COREOS_PRIVATE_IPV4}
) > ${ENV}

sed -i -e "s,@@homedir@@,${HOMEDIR},g" \
    -e "s,@@nfsServer@@,${NFS},g" \
    -e "s,Users@\.mount,$(systemd-escape -p ${HOMEDIR})\.mount,g" \
    /usr/share/oem/corectl.yml

rm -rf ${META}
